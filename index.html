<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hera MCQs Online Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f4f6fb;margin:0}
.container{max-width:900px;margin:auto;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
h2{text-align:center;color:#2d5be3}
input,textarea,select,button{
width:100%;padding:10px;margin:5px 0;border-radius:6px;border:1px solid #ccc}
button{background:#2d5be3;color:#fff;border:none;cursor:pointer}
.hidden{display:none}
.palette span{
display:inline-block;width:34px;height:34px;line-height:34px;
margin:4px;border-radius:50%;background:#ddd;cursor:pointer}
.palette .done{background:#2d5be3;color:white}
.options label{display:block;padding:8px;border:1px solid #ccc;margin:5px 0;border-radius:6px;cursor:pointer}
.nav{display:flex;gap:10px;margin-top:10px}
</style>
</head>

<body>
<div class="container">

<h2>Hera English School – Online MCQs</h2>

<!-- TEACHER PANEL -->
<div class="card">
<h3>Teacher Panel</h3>

<input id="teacherName" placeholder="Teacher Name">
<input id="testName" placeholder="Test Name">
<textarea id="questionsBox" rows="6"
placeholder="Q?|A|B|C|0"></textarea>

<button onclick="saveTest()">Save / Update Test</button>

<h4>Available Tests</h4>
<div id="testsList"></div>

<h4>Student Attempts</h4>
<div id="attempts"></div>
</div>

<!-- STUDENT PANEL -->
<div class="card">
<h3>Student Panel</h3>
<input id="studentName" placeholder="Student Name">
<input id="studentClass" placeholder="Class">
<select id="testSelect"></select>
<button onclick="startTest()">Start Test</button>
</div>

<!-- EXAM -->
<div class="card hidden" id="exam">
<div class="palette" id="palette"></div>
<h3 id="qText"></h3>
<div class="options" id="options"></div>

<div class="nav">
<button onclick="prevQ()">Previous</button>
<button id="nextBtn" onclick="nextQ()">Next</button>
<button onclick="submitTest()">Submit</button>
</div>
</div>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyChhkiu5e6fKVowh2RRvkegVdTwn7yV8Zc",
  authDomain: "hera-mcqs.firebaseapp.com",
  projectId: "hera-mcqs",
  storageBucket: "hera-mcqs.firebasestorage.app",
  messagingSenderId: "284002289050",
  appId: "1:284002289050:web:e98f219b72f5c7cc3c6623"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let editId=null, questions=[], answers=[], index=0;

/* TEACHER */
async function saveTest(){
  const data={
    teacher:teacherName.value,
    name:testName.value,
    questions:questionsBox.value
  };
  editId
    ? await db.collection("tests").doc(editId).set(data)
    : await db.collection("tests").add(data);

  editId=null;
  alert("Test saved");
  questionsBox.value=""; testName.value="";
}

db.collection("tests").onSnapshot(s=>{
  testsList.innerHTML="";
  testSelect.innerHTML="";
  s.forEach(d=>{
    const t=d.data();
    testsList.innerHTML+=`
    <div>${t.name}
    <button onclick="editTest('${d.id}')">Edit</button>
    <button onclick="delTest('${d.id}')">Delete</button></div>`;
    testSelect.innerHTML+=`<option value="${d.id}">${t.name}</option>`;
  });
});

async function editTest(id){
  const d=await db.collection("tests").doc(id).get();
  teacherName.value=d.data().teacher;
  testName.value=d.data().name;
  questionsBox.value=d.data().questions;
  editId=id;
}
function delTest(id){
  if(confirm("Delete test?")) db.collection("tests").doc(id).delete();
}

/* STUDENT */
async function startTest(){
  const doc=await db.collection("tests").doc(testSelect.value).get();
  questions=doc.data().questions.trim().split("\n").map(l=>{
    const p=l.split("|");
    return{q:p[0],opts:p.slice(1,4),correct:Number(p[4])};
  }).sort(()=>Math.random()-0.5).slice(0,30);

  answers=Array(questions.length).fill(null);
  index=0;
  exam.classList.remove("hidden");
  showQ();
}

function showQ(){
  const q=questions[index];
  qText.innerText=`Q${index+1}. ${q.q}`;
  options.innerHTML="";
  q.opts.forEach((o,i)=>{
    options.innerHTML+=`
    <label>
    <input type="radio" name="opt"
    ${answers[index]==i?"checked":""}
    onclick="answers[${index}]=${i};drawPalette()">${o}
    </label>`;
  });
  drawPalette();
  nextBtn.style.display=index==questions.length-1?"none":"block";
}

function drawPalette(){
  palette.innerHTML="";
  answers.forEach((a,i)=>{
    palette.innerHTML+=`
    <span class="${a!==null?"done":""}"
    onclick="index=${i};showQ()">${i+1}</span>`;
  });
}

function nextQ(){ if(index<questions.length-1){index++;showQ();}}
function prevQ(){ if(index>0){index--;showQ();}}

async function submitTest(){
  if(!confirm("Submit test?")) return;
  let score=0;
  questions.forEach((q,i)=>{ if(answers[i]===q.correct) score++; });

  await db.collection("attempts").add({
    name:studentName.value,
    class:studentClass.value,
    test:testSelect.options[testSelect.selectedIndex].text,
    score, total:questions.length,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert(`Submitted\nScore: ${score}/${questions.length}`);
  exam.classList.add("hidden");
  window.scrollTo(0,0);
}

/* ATTEMPTS */
db.collection("attempts").orderBy("time","desc")
.onSnapshot(s=>{
  attempts.innerHTML="";
  s.forEach(d=>{
    const a=d.data();
    attempts.innerHTML+=`
    <div>${a.name} (${a.class}) – ${a.test}
    : ${a.score}/${a.total}</div>`;
  });
});
</script>
</body>
</html>
