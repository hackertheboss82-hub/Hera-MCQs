<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MCQ Online Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{background:#f1f5f9}
.hidden{display:none}
.option{border:1px solid #ccc;padding:10px;margin:6px 0;border-radius:6px;cursor:pointer}
.option:hover{background:#e0f2fe}
.answered{background:#22c55e;color:#fff}
.palette button{width:38px;margin:3px}
.timer{font-weight:bold;color:#dc2626}
</style>
</head>

<body oncontextmenu="return false">

<div class="container my-4">

<h3 class="text-center mb-4">ðŸ“˜ MCQ Online Test System</h3>

<!-- STUDENT ENTRY -->
<div id="studentEntry" class="card p-4">
<h5>Student Details</h5>
<input id="stName" class="form-control mb-2" placeholder="Student Name">
<input id="stRoll" class="form-control mb-2" placeholder="Roll Number">
<select id="stClass" class="form-select mb-2">
<option value="">Select Class</option>
<option>1</option><option>2</option><option>3</option><option>4</option>
<option>5</option><option>6</option><option>7</option><option>8</option>
<option>9</option><option>10</option>
</select>
<button class="btn btn-primary" onclick="loadTests()">Load Tests</button>
</div>

<!-- TEST LIST -->
<div id="testListCard" class="card p-4 mt-3 hidden">
<h5>Select Test</h5>
<div id="testList"></div>
</div>

<!-- TEST SCREEN -->
<div id="testScreen" class="card p-4 mt-3 hidden">
<div class="timer mb-2" id="timer"></div>
<div id="palette" class="mb-3"></div>
<div id="qBox"></div>
<div class="d-flex justify-content-between mt-3">
<button class="btn btn-secondary" onclick="prevQ()">Prev</button>
<button class="btn btn-secondary" onclick="nextQ()">Next</button>
<button class="btn btn-danger" onclick="submitTest()">Submit</button>
</div>
</div>

<!-- TEACHER LOGIN -->
<div id="teacherLogin" class="card p-4 mt-4">
<h5>Teacher Login</h5>
<input id="tPin" type="password" class="form-control mb-2" placeholder="Enter PIN">
<button class="btn btn-dark" onclick="teacherLogin()">Login</button>
</div>

<!-- TEACHER PANEL -->
<div id="teacherPanel" class="card p-4 mt-3 hidden">
<h5>Create Test</h5>
<input id="testName" class="form-control mb-2" placeholder="Test Name">
<select id="testClass" class="form-select mb-2">
<option>1</option><option>2</option><option>3</option><option>4</option>
<option>5</option><option>6</option><option>7</option><option>8</option>
<option>9</option><option>10</option>
</select>
<input id="testTime" type="number" class="form-control mb-2" placeholder="Time (minutes)">
<textarea id="questionsText" rows="10" class="form-control mb-2"
placeholder="Question
Option1
Option2
Option3
Option4
CorrectIndex(0-3)
(repeat)"></textarea>
<button class="btn btn-success" onclick="saveTest()">Save Test</button>

<hr>
<h5>Attempts</h5>
<table class="table">
<thead>
<tr><th>Name</th><th>Roll</th><th>Class</th><th>Score</th><th>Status</th></tr>
</thead>
<tbody id="attemptTable"></tbody>
</table>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ðŸ”¥ FIREBASE CONFIG (REPLACE) */
const firebaseConfig = {
apiKey: "YOUR_API_KEY",
databaseURL: "YOUR_DATABASE_URL",
projectId: "YOUR_PROJECT_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* GLOBALS */
let student={}, questions=[], answers=[], current=0, timerInt, timeLeft;
let activeTestId="", activeTestData={};

/* STUDENT */
function loadTests(){
let n=stName.value, r=stRoll.value, c=stClass.value;
if(!n||!r||!c) return alert("Fill all fields");
student={name:n, roll:r, class:c};
testList.innerHTML="";
db.ref("tests").orderByChild("class").equalTo(c).once("value",s=>{
s.forEach(t=>{
let b=document.createElement("button");
b.className="btn btn-outline-primary m-1";
b.innerText=t.val().name;
b.onclick=()=>checkAttempt(t.key,t.val());
testList.appendChild(b);
});
studentEntry.classList.add("hidden");
testListCard.classList.remove("hidden");
});
}

function checkAttempt(id,data){
db.ref(`attempts/${id}/${student.class}/${student.roll}`).once("value",s=>{
if(s.exists() && s.val().status==="submitted"){
alert("You already submitted this test");
}else{
startTest(id,data);
}
});
}

/* TEST */
function startTest(id,data){
activeTestId=id;
activeTestData=data;
questions=shuffle(data.questions).slice(0,30);
answers=new Array(questions.length).fill(null);
current=0;
timeLeft=data.time*60;
testListCard.classList.add("hidden");
testScreen.classList.remove("hidden");
renderPalette();
renderQ();
startTimer();
db.ref(`attempts/${id}/${student.class}/${student.roll}`).set({
name:student.name,
roll:student.roll,
class:student.class,
status:"in_progress"
});
}

function renderPalette(){
palette.innerHTML="";
questions.forEach((q,i)=>{
let b=document.createElement("button");
b.innerText=i+1;
b.className=answers[i]==null?"btn btn-secondary":"btn btn-success";
b.onclick=()=>{current=i;renderQ()};
palette.appendChild(b);
});
}

function renderQ(){
let q=questions[current];
qBox.innerHTML=`<h6>${current+1}. ${q.q}</h6>`;
q.opts.forEach((o,i)=>{
let d=document.createElement("div");
d.className="option";
if(answers[current]===i)d.classList.add("answered");
d.innerText=o;
d.onclick=()=>{answers[current]=i;renderQ();renderPalette()};
qBox.appendChild(d);
});
}

function nextQ(){if(current<questions.length-1){current++;renderQ()}}
function prevQ(){if(current>0){current--;renderQ()}}

function startTimer(){
timerInt=setInterval(()=>{
let m=Math.floor(timeLeft/60),s=timeLeft%60;
timer.innerText=`Time Left: ${m}:${s<10?"0":""}${s}`;
timeLeft--;
if(timeLeft<0)submitTest();
},1000);
}

function submitTest(){
clearInterval(timerInt);
let score=0;
questions.forEach((q,i)=>{if(answers[i]===q.ans)score++});
db.ref(`attempts/${activeTestId}/${student.class}/${student.roll}`).update({
status:"submitted",
score:`${score}/${questions.length}`,
time:new Date().toLocaleString()
});
alert("Test Submitted\nScore: "+score+"/"+questions.length);
location.reload();
}

/* TEACHER */
function teacherLogin(){
if(tPin.value==="1914"){
teacherLogin.classList.add("hidden");
teacherPanel.classList.remove("hidden");
loadAttempts();
}else alert("Wrong PIN");
}

function saveTest(){
let raw=questionsText.value.trim().split("\n");
let qs=[];
for(let i=0;i<raw.length;i+=6){
if(!raw[i+5])break;
qs.push({
q:raw[i],
opts:[raw[i+1],raw[i+2],raw[i+3],raw[i+4]],
ans:parseInt(raw[i+5])
});
}
let id=Date.now();
db.ref("tests/"+id).set({
name:testName.value,
class:testClass.value,
time:parseInt(testTime.value),
questions:qs
});
alert("Test Saved");
questionsText.value="";
}

function loadAttempts(){
attemptTable.innerHTML="";
db.ref("attempts").once("value",s=>{
s.forEach(t=>{
t.forEach(c=>{
c.forEach(r=>{
let d=r.val();
attemptTable.innerHTML+=`<tr>
<td>${d.name||""}</td>
<td>${d.roll||""}</td>
<td>${d.class||""}</td>
<td>${d.score||""}</td>
<td>${d.status}</td>
</tr>`;
});
});
});
});
}

/* UTILS */
function shuffle(a){return a.sort(()=>Math.random()-0.5)}
</script>

</body>
</html>
