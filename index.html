<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HERA MCQ TEST SYSTEM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body { background:#f4f6fb; user-select:none }
.hidden { display:none }
.option { border:1px solid #ccc; padding:10px; border-radius:8px; margin:6px 0; cursor:pointer }
.option input { width:22px; height:22px; margin-right:10px }
.palette button { width:42px; height:42px; border-radius:50%; margin:4px }
.done { background:#22c55e; color:#fff }
.current { background:#f59e0b; color:#fff }
.pending { background:#d1d5db }
.timer { font-weight:bold; color:#dc2626; text-align:center }
</style>
</head>

<body oncontextmenu="return false">

<header class="bg-primary text-white p-3 text-center">
<h3>ðŸ“˜ HERA MCQ TEST SYSTEM</h3>
</header>

<div class="container my-4">

<!-- LOGIN -->
<div class="card p-4" id="loginBox">
<h4>Student / Teacher Login</h4>

<select id="role" class="form-select mb-2">
<option value="student">Student</option>
<option value="teacher">Teacher</option>
</select>

<input id="name" class="form-control mb-2" placeholder="Student Name">
<input id="roll" class="form-control mb-2" placeholder="Roll Number">
<select id="class" class="form-select mb-2">
<option value="">Select Class</option>
<option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
<option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
</select>

<input id="pin" class="form-control mb-2 hidden" placeholder="Teacher PIN" type="password">

<button class="btn btn-primary w-100" onclick="login()">Login</button>
</div>

<!-- TEACHER PANEL -->
<div class="card p-4 hidden" id="teacherPanel">
<h4>Teacher Panel</h4>

<input id="testTitle" class="form-control mb-2" placeholder="Test Name">
<select id="testClass" class="form-select mb-2">
<option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
<option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
</select>
<input id="testTime" class="form-control mb-2" type="number" placeholder="Time (minutes)">

<textarea id="questions" class="form-control mb-2" rows="10"
placeholder="Question
Option1
Option2
Option3
Option4
CorrectIndex(0-3)

(repeat)"></textarea>

<button class="btn btn-success" onclick="saveTest()">Save Test</button>

<hr>
<h5>Tests</h5>
<div id="teacherTests"></div>

<button class="btn btn-secondary mt-3" onclick="logout()">Logout</button>
</div>

<!-- STUDENT PANEL -->
<div class="card p-4 hidden" id="studentPanel">
<h4 id="testName"></h4>
<div class="timer" id="timer"></div>
<div id="questionBox"></div>

<div class="d-flex justify-content-between mt-3">
<button class="btn btn-secondary" onclick="prevQ()">Prev</button>
<button class="btn btn-secondary" onclick="nextQ()">Next</button>
<button class="btn btn-danger" onclick="submitConfirm()">Submit</button>
</div>

<div class="palette mt-3" id="palette"></div>
</div>

</div>

<script>
const firebaseConfig = {
apiKey: "AIzaSyBQ2-dTUTPwhf7WqceEwXpk9CtPksR1xCk",
databaseURL: "https://hera-mcqs-55022-default-rtdb.firebaseio.com",
projectId: "hera-mcqs-55022"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let role, studentKey, studentClass, testData, qIndex=0, answers={}, timerInt, timeLeft;

/* ROLE CHANGE */
role.onchange = () => {
pin.classList.toggle("hidden", role.value !== "teacher");
};

/* LOGIN */
function login(){
if(role.value==="teacher"){
if(pin.value!=="1914") return alert("Wrong PIN");
loginBox.classList.add("hidden");
teacherPanel.classList.remove("hidden");
loadTeacherTests();
return;
}

if(!name.value||!roll.value||!class.value) return alert("Fill all fields");
studentClass = class.value;
studentKey = `${studentClass}_${roll.value}_${name.value}`;

loadStudentTest();
}

/* LOAD STUDENT TEST */
function loadStudentTest(){
db.ref(`attempts/${studentKey}`).once("value", a=>{
if(a.exists() && a.val().submitted) return alert("Already submitted");

db.ref(`tests/${studentClass}`).orderByChild("active").equalTo(true).limitToFirst(1)
.once("value", s=>{
if(!s.exists()) return alert("No active test");
let k = Object.keys(s.val())[0];
testData = s.val()[k];

if(a.exists()){
answers = a.val().answers||{};
qIndex = a.val().qIndex||0;
timeLeft = a.val().timeLeft;
}else{
answers={};
timeLeft = testData.time*60;
}

startTest();
});
});
}

function startTest(){
loginBox.classList.add("hidden");
studentPanel.classList.remove("hidden");
testName.innerText = testData.title;
startTimer();
showQ();
}

/* QUESTIONS */
function showQ(){
let q = testData.questions[qIndex];
questionBox.innerHTML = `<h5>${qIndex+1}. ${q.q}</h5>`;
q.opts.forEach((o,i)=>{
questionBox.innerHTML += `
<div class="option">
<input type="radio" name="opt" ${answers[qIndex]==i?"checked":""}
onclick="answers[${qIndex}]=${i};saveProgress()">
${o}
</div>`;
});
drawPalette();
}

function nextQ(){ if(qIndex<testData.questions.length-1){ qIndex++; showQ(); saveProgress();}}
function prevQ(){ if(qIndex>0){ qIndex--; showQ(); saveProgress();}}

function drawPalette(){
palette.innerHTML="";
testData.questions.forEach((_,i)=>{
let b=document.createElement("button");
b.innerText=i+1;
b.className=answers[i]!=null?"done":"pending";
if(i===qIndex) b.className="current";
b.onclick=()=>{qIndex=i;showQ()};
palette.appendChild(b);
});
}

/* TIMER */
function startTimer(){
timerInt=setInterval(()=>{
timeLeft--;
timer.innerText=`Time: ${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,"0")}`;
saveProgress();
if(timeLeft<=0) submit();
},1000);
}

/* SAVE PROGRESS */
function saveProgress(){
db.ref(`attempts/${studentKey}`).set({
class:studentClass,
test:testData.title,
answers,
qIndex,
timeLeft,
submitted:false
});
}

/* SUBMIT */
function submitConfirm(){ if(confirm("Submit test?")) submit(); }

function submit(){
clearInterval(timerInt);
let score=0;
testData.questions.forEach((q,i)=>{ if(answers[i]==q.ans) score++;});
db.ref(`attempts/${studentKey}`).update({
submitted:true,
score:`${score}/${testData.questions.length}`,
time:new Date().toLocaleString()
});
alert(`Submitted! Score: ${score}`);
location.reload();
}

/* TEACHER */
function saveTest(){
let blocks=questions.value.trim().split(/\n\s*\n/);
let qs=[];
blocks.forEach(b=>{
let l=b.split("\n");
if(l.length>=6) qs.push({q:l[0],opts:l.slice(1,5),ans:+l[5]});
});
db.ref(`tests/${testClass.value}/${testTitle.value}`).set({
title:testTitle.value,
class:testClass.value,
time:+testTime.value,
questions:qs,
active:true
});
alert("Saved");
loadTeacherTests();
}

function loadTeacherTests(){
teacherTests.innerHTML="";
db.ref("tests").once("value",s=>{
s.forEach(c=>{
c.forEach(t=>{
let d=t.val();
teacherTests.innerHTML+=`
<div>${d.title} (${c.key})
<button onclick="toggle('${c.key}','${d.title}',${!d.active})">
${d.active?"Deactivate":"Activate"}
</button></div>`;
});
});
});
}

function toggle(cls,title,val){
db.ref(`tests/${cls}/${title}/active`).set(val);
loadTeacherTests();
}

function logout(){ location.reload(); }
</script>

</body>
</html>
