<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>School Test System</title>
<style>
body{font-family:Arial;background:#f4f4f4;padding:20px}
.box{background:#fff;padding:15px;margin-bottom:20px;border-radius:5px}
.hidden{display:none}
input,select,button{padding:8px;margin:5px;width:100%}
button{cursor:pointer;background:#2b7cff;color:white;border:none}
.question{border:1px solid #ddd;padding:10px;margin:10px 0}
</style>
</head>
<body>

<h2>Online Test System</h2>

<!-- TEACHER LOGIN -->
<div id="teacherLogin" class="box">
<h3>Teacher Login</h3>
<input type="password" id="teacherPin" placeholder="Enter PIN">
<button onclick="teacherLogin()">Login</button>
</div>

<!-- TEACHER PANEL -->
<div id="teacherPanel" class="box hidden">
<h3>Teacher Panel</h3>
<button onclick="logoutTeacher()">Logout</button>

<h4>Create Test</h4>
<input id="tClass" placeholder="Class (e.g. 10A)">
<input id="tName" placeholder="Test Name">

<div id="questions"></div>
<button onclick="addQuestion()">Add Question</button>
<button onclick="saveTest()">Save Test</button>

<h4>Student Attempts</h4>
<select id="viewClass" onchange="loadAttempts()"></select>
<select id="viewTest" onchange="loadAttempts()"></select>
<div id="attempts"></div>
</div>

<!-- STUDENT PANEL -->
<div id="studentPanel" class="box">
<h3>Student Panel</h3>
<input id="sName" placeholder="Student Name">
<input id="sRoll" placeholder="Roll Number">
<input id="sClass" placeholder="Class">
<button onclick="loadStudentTest()">Load Test</button>

<div id="testBox" class="hidden">
<h3 id="testTitle"></h3>
<div id="studentQuestions"></div>
<button onclick="submitTest()">Submit Test</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBQ2-dTUTPwhf7WqceEwXpk9CtPksR1xCk",
  authDomain: "hera-mcqs-55022.firebaseapp.com",
  databaseURL: "https://hera-mcqs-55022-default-rtdb.firebaseio.com",
  projectId: "hera-mcqs-55022",
  storageBucket: "hera-mcqs-55022.appspot.com"
});
</script>

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let testData = [];
let currentTest = "";
let student = {};

window.teacherLogin = function(){
  if(document.getElementById("teacherPin").value==="1914"){
    teacherLoginBox(true);
    loadClasses();
  } else alert("Wrong PIN");
}

function teacherLoginBox(show){
  teacherLogin.classList.toggle("hidden",show);
  teacherPanel.classList.toggle("hidden",!show);
}

window.logoutTeacher=()=>teacherLoginBox(false);

window.addQuestion = function(){
  const q = document.createElement("div");
  q.className="question";
  q.innerHTML=`
    <input placeholder="Question">
    <input placeholder="Option A">
    <input placeholder="Option B">
    <input placeholder="Option C">
    <input placeholder="Option D">
    <select>
      <option value="0">A</option>
      <option value="1">B</option>
      <option value="2">C</option>
      <option value="3">D</option>
    </select>`;
  questions.appendChild(q);
}

window.saveTest = function(){
  const cls=tClass.value,test=tName.value;
  if(!cls||!test)return alert("Fill class & test");
  let qs=[];
  [...questions.children].forEach(q=>{
    const i=q.querySelectorAll("input");
    qs.push({
      q:i[0].value,
      o:[i[1].value,i[2].value,i[3].value,i[4].value],
      a:q.querySelector("select").value
    });
  });
  set(ref(db,`tests/${cls}/${test}`),qs);
  alert("Test Saved");
  questions.innerHTML="";
}

window.loadStudentTest = function(){
  student={name:sName.value,roll:sRoll.value,class:sClass.value};
  get(ref(db,`tests/${student.class}`)).then(s=>{
    if(!s.exists())return alert("No test");
    currentTest=Object.keys(s.val())[0];
    testData=s.val()[currentTest];
    const key=`${student.class}_${currentTest}_${student.roll}`;
    get(ref(db,`attempts/${key}`)).then(a=>{
      if(a.exists() && a.val().submitted)return alert("Already submitted");
      renderStudentTest(a.exists()?a.val().answers:{});
    });
  });
}

function renderStudentTest(ans){
  testTitle.innerText=currentTest;
  studentQuestions.innerHTML="";
  testData.forEach((q,i)=>{
    studentQuestions.innerHTML+=`
    <div class="question">
    <p>${q.q}</p>
    ${q.o.map((o,idx)=>`
      <label><input type="radio" name="q${i}" value="${idx}" ${ans?.[i]==idx?"checked":""}> ${o}</label><br>`).join("")}
    </div>`;
  });
  testBox.classList.remove("hidden");
}

window.submitTest=function(){
  let answers={};
  testData.forEach((_,i)=>{
    const r=document.querySelector(`input[name=q${i}]:checked`);
    if(r)answers[i]=r.value;
  });
  const key=`${student.class}_${currentTest}_${student.roll}`;
  set(ref(db,`attempts/${key}`),{name:student.name,answers,submitted:true});
  alert("Test Submitted");
  testBox.classList.add("hidden");
}

function loadClasses(){
  onValue(ref(db,"tests"),s=>{
    viewClass.innerHTML="<option>Select Class</option>";
    if(!s.exists())return;
    Object.keys(s.val()).forEach(c=>{
      viewClass.innerHTML+=`<option>${c}</option>`;
    });
  });
}

window.loadAttempts=function(){
  const c=viewClass.value,t=viewTest.value;
  if(!c)return;
  onValue(ref(db,`tests/${c}`),s=>{
    viewTest.innerHTML="<option>Select Test</option>";
    Object.keys(s.val()).forEach(tn=>viewTest.innerHTML+=`<option>${tn}</option>`);
  });
  if(!t)return;
  onValue(ref(db,"attempts"),s=>{
    attempts.innerHTML="";
    if(!s.exists())return;
    Object.keys(s.val()).forEach(k=>{
      if(k.startsWith(`${c}_${t}_`)){
        attempts.innerHTML+=`<div>${s.val()[k].name}
        <button onclick="remove(ref(db,'attempts/${k}'))">Reset</button></div>`;
      }
    });
  });
}
</script>
</body>
</html>
