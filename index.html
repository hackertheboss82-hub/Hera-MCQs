<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Online Exam System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Libraries for Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #eef2f7;
  margin: 0;
}
.container {
  max-width: 900px;
  background: #fff;
  margin: 15px auto;
  padding: 15px;
  border-radius: 8px;
}
h2 { text-align: center; color: #2c3e50; }
input, textarea, button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  font-size: 16px;
}
button {
  background: #2563eb;
  color: #fff;
  border: none;
  cursor: pointer;
}
button:hover { background: #1e40af; }
.hidden { display: none; }
.question-box {
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  margin-top: 12px;
}
.timer {
  text-align: center;
  font-size: 18px;
  color: red;
  margin-bottom: 10px;
}
.option { margin: 6px 0; }
@media(max-width:600px){
  h2 { font-size: 20px; }
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginPanel">
<h2>ğŸ” Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p><b>Admin:</b> admin / admin123</p>
<p><b>Teacher:</b> teacher / teacher123</p>
</div>

<!-- TEACHER PANEL -->
<div class="container hidden" id="teacherPanel">
<h2>ğŸ‘¨â€ğŸ« Teacher Panel</h2>

<input id="testName" placeholder="Test Name">
<input id="testDuration" type="number" value="30" min="5">

<textarea id="questionInput" rows="8"
placeholder="Question | opt1 | opt2 | opt3 | opt4 | correctIndex"></textarea>

<button onclick="saveTest()">Save Test</button>
<button onclick="startStudent()">Open Student Test</button>
<button onclick="exportExcel()">Export Result (Excel)</button>
<button onclick="exportPDF()">Export Result (PDF)</button>
</div>

<!-- STUDENT PANEL -->
<div class="container hidden" id="studentPanel">
<h2>ğŸ‘¨â€ğŸ“ Student Test</h2>
<div class="timer" id="timer"></div>
<div id="questionsArea"></div>
<button onclick="submitTest()">Submit Test</button>
</div>

<script>
let role = "";
let testData = {};
let studentAnswers = {};
let studentQuestions = [];
let results = [];
let timerInterval;

// LOGIN
function login() {
  const u = username.value;
  const p = password.value;

  if (u === "admin" && p === "admin123") role = "admin";
  else if (u === "teacher" && p === "teacher123") role = "teacher";
  else return alert("Invalid login");

  loginPanel.classList.add("hidden");
  teacherPanel.classList.remove("hidden");
}

// SAVE TEST
function saveTest() {
  const raw = questionInput.value.trim();
  if (!raw) return alert("Add questions");

  testData = {
    name: testName.value,
    duration: parseInt(testDuration.value),
    questions: raw.split("\n").filter(q => q.trim())
  };
  alert("Test saved");
}

// START STUDENT
function startStudent() {
  if (!testData.questions) return alert("Save test first");

  teacherPanel.classList.add("hidden");
  studentPanel.classList.remove("hidden");

  studentAnswers = {};
  studentQuestions = shuffle([...testData.questions]).slice(0, 30);
  renderStudent();
  startTimer(testData.duration);
}

// PARSE
function parseQ(raw) {
  const p = raw.split("|").map(x => x.trim());
  return { q: p[0], opts: p.slice(1,5), ans: parseInt(p[5]) };
}

// RENDER STUDENT
function renderStudent() {
  questionsArea.innerHTML = "";
  studentQuestions.forEach((raw, i) => {
    const q = parseQ(raw);
    const div = document.createElement("div");
    div.className = "question-box";
    div.innerHTML = `<b>Q${i+1}. ${q.q}</b>`;
    q.opts = shuffle(q.opts);
    q.opts.forEach((o, idx) => {
      div.innerHTML += `
      <div class="option">
        <label>
          <input type="radio" name="q${i}" value="${o}"
           onchange="studentAnswers[${i}]='${o}'"> ${o}
        </label>
      </div>`;
    });
    questionsArea.appendChild(div);
  });
}

// TIMER
function startTimer(min) {
  let t = min * 60;
  timerInterval = setInterval(() => {
    timer.innerText = `Time Left: ${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`;
    if (t-- <= 0) submitTest();
  },1000);
}

// SUBMIT
function submitTest() {
  clearInterval(timerInterval);
  let score = 0;

  studentQuestions.forEach((raw,i)=>{
    const q = parseQ(raw);
    if (studentAnswers[i] === q.opts[q.ans]) score++;
  });

  results.push({ Test: testData.name, Score: score });
  alert("Test Submitted! Score: " + score);
  location.reload();
}

// SHUFFLE
function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

// EXPORT EXCEL
function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(results);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Results");
  XLSX.writeFile(wb, "results.xlsx");
}

// EXPORT PDF
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;
  results.forEach((r,i)=>{
    doc.text(`${i+1}. ${r.Test} - Score: ${r.Score}`, 10, y);
    y += 10;
  });
  doc.save("results.pdf");
}
</script>

</body>
</html>
