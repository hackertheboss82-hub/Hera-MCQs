<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>School MCQ Test System</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 20px;
}
h2,h3 { margin-top: 0 }
.card {
  background: #fff;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
button {
  padding: 10px 16px;
  margin: 5px;
  cursor: pointer;
}
input, textarea {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
}
.hidden { display:none }
.timer {
  font-weight: bold;
  color: #c0392b;
}
.nav-btns {
  margin-top: 15px;
}
</style>
</head>

<body>

<h2>MCQ Online Test</h2>

<button onclick="openStudent()">Student</button>
<button onclick="openTeacherLogin()">Teacher</button>

<!-- STUDENT PANEL -->
<div id="studentPanel" class="card hidden">
  <h3>Student Panel</h3>
  <input id="studentName" placeholder="Enter your name">
  <button onclick="loadStudentTests()">Load Tests</button>
  <div id="studentTests"></div>
  <div id="examArea"></div>
</div>

<!-- TEACHER LOGIN -->
<div id="teacherLogin" class="card hidden">
  <h3>Teacher Login</h3>
  <input type="password" id="teacherPin" placeholder="Enter PIN">
  <button onclick="loginTeacher()">Login</button>
</div>

<!-- TEACHER PANEL -->
<div id="teacherPanel" class="card hidden">
  <h3>Teacher Panel</h3>

  <input id="testTitle" placeholder="Test Name">
  <input id="testTime" type="number" placeholder="Time (minutes)">

  <textarea id="questionBox" rows="10"
placeholder="Question
Option1
Option2
Option3
Option4
CorrectIndex (0-based)
(repeat for next question)"></textarea>

  <button onclick="createTest()">Create Test</button>

  <h4>Existing Tests</h4>
  <div id="teacherTests"></div>

  <h4>Student Attempts</h4>
  <div id="attempts"></div>
</div>

<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyBQ2-dTUTPwhf7WqceEwXpk9CtPksR1xCk",
  authDomain: "hera-mcqs-55022.firebaseapp.com",
  databaseURL: "https://hera-mcqs-55022-default-rtdb.firebaseio.com",
  projectId: "hera-mcqs-55022",
  storageBucket: "hera-mcqs-55022.firebasestorage.app",
  messagingSenderId: "878791404574",
  appId: "1:878791404574:web:a0ec3ab2819423aa09120f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= UI HELPERS =================
function hideAll(){
  studentPanel.classList.add("hidden");
  teacherLogin.classList.add("hidden");
  teacherPanel.classList.add("hidden");
}
function openStudent(){ hideAll(); studentPanel.classList.remove("hidden"); }
function openTeacherLogin(){ hideAll(); teacherLogin.classList.remove("hidden"); }

// ================= TEACHER =================
function loginTeacher(){
  if(teacherPin.value === "1914"){
    teacherLogin.classList.add("hidden");
    teacherPanel.classList.remove("hidden");
    loadTeacherTests();
    loadAttempts();
  } else {
    alert("Wrong PIN");
  }
}

function createTest(){
  if(!testTitle.value || !testTime.value){
    alert("Fill test name and time");
    return;
  }

  const lines = questionBox.value.split("\n").map(l=>l.trim()).filter(l=>l);
  if(lines.length % 6 !== 0){
    alert("Question format incorrect");
    return;
  }

  let questions = [];
  for(let i=0;i<lines.length;i+=6){
    questions.push({
      question: lines[i],
      options: [lines[i+1],lines[i+2],lines[i+3],lines[i+4]],
      correct: Number(lines[i+5])
    });
  }

  db.ref("tests").push({
    title: testTitle.value,
    time: Number(testTime.value),
    questions: questions
  });

  alert("Test created");
  questionBox.value="";
  loadTeacherTests();
}

function loadTeacherTests(){
  teacherTests.innerHTML="";
  db.ref("tests").once("value",snap=>{
    snap.forEach(t=>{
      teacherTests.innerHTML += `
        <div>
          ${t.val().title}
          <button onclick="deleteTest('${t.key}')">Delete</button>
        </div>`;
    });
  });
}

function deleteTest(id){
  if(confirm("Delete this test?")){
    db.ref("tests/"+id).remove();
    loadTeacherTests();
  }
}

function loadAttempts(){
  attempts.innerHTML="";
  db.ref("attempts").on("value",snap=>{
    attempts.innerHTML="";
    snap.forEach(test=>{
      test.forEach(att=>{
        const v=att.val();
        attempts.innerHTML += `<div>${v.student} | ${v.score} | ${v.date}</div>`;
      });
    });
  });
}

// ================= STUDENT =================
function loadStudentTests(){
  if(!studentName.value){
    alert("Enter your name");
    return;
  }
  studentTests.innerHTML="";
  db.ref("tests").once("value",snap=>{
    snap.forEach(t=>{
      studentTests.innerHTML +=
      `<button onclick="startTest('${t.key}')">${t.val().title}</button>`;
    });
  });
}

let exam=[], answers=[], qIndex=0, timerInt, timeLeft, currentTestId;

function startTest(id){
  currentTestId=id;
  db.ref("tests/"+id).once("value",snap=>{
    const data=snap.val();
    exam = data.questions.sort(()=>0.5-Math.random()).slice(0,30);
    answers=[];
    qIndex=0;
    timeLeft = data.time * 60;
    runTimer();
    showQuestion();
  });
}

function runTimer(){
  clearInterval(timerInt);
  timerInt = setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){
      submitTest();
    }
    document.getElementById("timeBox").innerText =
      "Time Left: " + timeLeft + " sec";
  },1000);
}

function showQuestion(){
  const q = exam[qIndex];
  examArea.innerHTML = `
    <div class="timer" id="timeBox"></div>
    <h4>Question ${qIndex+1} / 30</h4>
    <p>${q.question}</p>
    ${q.options.map((o,i)=>`
      <label>
        <input type="radio" name="opt" value="${i}"
        ${answers[qIndex]==i?"checked":""}
        onclick="answers[${qIndex}]=${i}">
        ${o}
      </label><br>`).join("")}
    <div class="nav-btns">
      <button onclick="prevQ()">Previous</button>
      <button onclick="nextQ()">Next</button>
      <button onclick="submitTest()">Submit</button>
    </div>
  `;
}

function nextQ(){ if(qIndex<exam.length-1){ qIndex++; showQuestion(); } }
function prevQ(){ if(qIndex>0){ qIndex--; showQuestion(); } }

function submitTest(){
  clearInterval(timerInt);
  let score=0;
  exam.forEach((q,i)=>{
    if(answers[i]===q.correct) score++;
  });

  db.ref("attempts/"+currentTestId).push({
    student: studentName.value,
    score: score,
    date: new Date().toLocaleString()
  });

  examArea.innerHTML = `<h3>Test Submitted</h3>
  <p>Your Score: ${score} / 30</p>`;
}
</script>

</body>
</html>
